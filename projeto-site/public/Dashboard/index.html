<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://www.chartjs.org/dist/2.9.3/Chart.min.js"></script>
    <script src="https://www.chartjs.org/samples/latest/utils.js"></script>
    <script src="https://kit.fontawesome.com/48b24e7021.js" crossorigin="anonymous"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/global.css">
    <link rel="stylesheet" href="css/home/style.css">
    <title>Home</title>
</head>

<style>
    canvas {
        -moz-user-select: none;
        -webkit-user-select: none;
        -ms-user-select: none;
    }
</style>

<body>
    <header>
        <div class="container">
            <div class="options">
                <img src="img/frigologo.png">

                <div class="item actived">
                    <img src="img/icons/bar-chart-black.svg" id="actived">
                </div>
                <span id="span_actived">Home</span>

                <div class="item">
                    <img src="img/icons/addchart-black.svg">
                </div>
                <span>New Freezer</span>
            </div>

            <div class="perfil">
                <div class="options-perfil" id="card_option" style="display: none;">
                    <div class="item-perfil">
                        <img src="img/frigologo.png">
                        <span>Usuario</span>
                    </div>

                    <div class="item-perfil">
                        <img src="img/icons/power.svg">
                        <span>Power</span>
                    </div>
                </div>

                <div class="img-perfil" id="user_option">
                    <img src="img/icons/users.svg">
                </div>
            </div>
        </div>
    </header>

    <section class="dashboard">
        <div class="container">
            <section id="sec_graphic" class="graphic" style="display: none;">
                <div class="cont-grafico">
                    <div class="title">
                        <h2>Gráfico do freezer</h2>
                        <span>Freezer 1</span>
                    </div>
                    <div class="graphic">
                        <canvas id="c_grafico"></canvas>
                    </div>
                </div>
                <div class="cont-dados">
                    <div class="title">
                        <h2>Últimos registros</h2>
                        <span>Freezer 1</span>
                    </div>
                    <div class="dados">
                        <div class="dado last">
                            <span>N:</span>
                            <span>Data</span>
                            <span>Hora</span>
                            <span>Status</span>
                        </div>
                        <div class="dado">
                            <span>10</span>
                            <span>15/11/20</span>
                            <span>12:00</span>
                            <span>Ideal</span>
                        </div>
                        <div class="dado">
                            <span>10</span>
                            <span>15/11/20</span>
                            <span>12:00</span>
                            <span>Ideal</span>
                        </div>
                        <div class="dado">
                            <span>10</span>
                            <span>15/11/20</span>
                            <span>12:00</span>
                            <span>Ideal</span>
                        </div>
                        <div class="dado">
                            <span>10</span>
                            <span>15/11/20</span>
                            <span>12:00</span>
                            <span>Ideal</span>
                        </div>
                        <div class="dado">
                            <span>10</span>
                            <span>15/11/20</span>
                            <span>12:00</span>
                            <span>Ideal</span>
                        </div>
                        <div class="dado">
                            <span>10</span>
                            <span>15/11/20</span>
                            <span>12:00</span>
                            <span>Ideal</span>
                        </div>
                        <div class="dado">
                            <span>10</span>
                            <span>15/11/20</span>
                            <span>12:00</span>
                            <span>Ideal</span>
                        </div>
                        <div class="dado">
                            <span>10</span>
                            <span>15/11/20</span>
                            <span>12:00</span>
                            <span>Ideal</span>
                        </div>
                        <div class="dado">
                            <span>10</span>
                            <span>15/11/20</span>
                            <span>12:00</span>
                            <span>Ideal</span>
                        </div>
                    </div>
                </div>
            </section>
            <section class="freezers">
                <div class="title">
                    <div>
                        <h2>Todos freezers</h2>
                        <p>Freezer 1 selecionado</p>
                    </div>
                    <i id="id_close" title="Fechar gráfico" class="fas fa-times fa-lg" style="display: none;"></i>
                </div>
                <div class="cont-freezers" id="cont-freezers"></div>
            </section>
        </div>
    </section>

</body>

</html>
<script src="js/header/functions.js"></script>

<script>
    window.onload = selecionar('bar-chart');

    // Função que busca todos os dados de todos os freezers em ordem de maior temperatura primeiro e insere na tela 
    function buscarFreezers() {
        // Rota de buscar dados do banco
        fetch(`/leituras/ultimas`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    resposta.reverse();

                    // console.log(resposta)
                    // console.log(resposta.length)

                    // Função para inserir os cards/botões na tela
                    inserirCards(resposta);
                    // Função para dar a função de click nos cards/botões
                    functionClickCard(resposta);

                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }


    function inserirCards(params) {
        // Limpa a div onde os freezeres vão aparecer
        document.getElementById('cont-freezers').innerHTML = '';

        // For para percorrer todo o JSON retornado da api  
        for (let i = 0; i < params.length; i++) {
            // Inserir o card/botão do freezer na tela
            // Id do freezer corresponde ao id do banco 
            // Cores e status são adicionados com a função de validar as temperaturas de acordo com a faixa de alertas 
            document.getElementById('cont-freezers').innerHTML += `
                            <div class="freezer" id="freezer${params[i].idFreezer}">
                                <img src="img/icons/freezer-${validarStatusTemp(params[i].temp).toLowerCase()}.png" id="${params[i].idFreezer}-img">
                                <span>Freezer ${params[i].idFreezer}</span>
                                <div class="status" id="status-freezer${params[i].idFreezer}">
                                    <h2 style="color: ${validarParaCores(params[i].temp)}">${params[i].temp}</h2>
                                    <span style="color: ${validarParaCores(params[i].temp)}">${validarStatusTemp(params[i].temp)}</span>
                                </div>
                            </div>
                        `;

            // Adicionar a borda do card de acordo com o status dele 
            document.getElementById(`freezer${params[i].idFreezer}`).style.borderColor = `${validarParaCores(params[i].temp)}`;
        }

        // Adicionando a sombra no primeiro botão
        document.getElementById(`freezer${params[0].idFreezer}`).style.boxShadow = `1px 1px 25px ${validarParaCores(params[0].temp)}`;
    }

    function functionClickCard(params) {

        for (let i = 0; i < params.length; i++) {
            // Adiciona a função de click nos botões
            console.log(`freezer${params[i].idFreezer}`)
            document.getElementById(`freezer${params[i].idFreezer}`).onclick = function () {
                alert('(barulinho do notebook do arthur)')
            }
        }
    }

    // Função responsável por trazer o ultimo registro do banco de dados, utilizando as rotas do node 
    // Função recebe um parametro que é referente a fk do sensor cadastrado no banco
    function buscarDadoPorSensor(idSensor) {
        fetch(`/leituras/ultima-leitura/${idSensor}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    resposta.reverse();

                    // Armazenando temperatura retornada do banco
                    let temp = Number(resposta[0].temp);
                    // Armazena na variavel o status da temperatura, (A Função faz todas as validações especificadas nas faixas de alerta)
                    let status = validarStatusTemp(temp)
                    // Armazena na variavel a cor do status da temperatura, (A Função faz todas as validações especificadas nas faixas de alerta)
                    let color = validarParaCores(temp);
                    // Apresentando a temperatura no freezer do sensor correspondente
                    // Função validar para cores está utilizando a temperatura para retornar qual cor do status da temperatura
                    // Função validarStatusTemp valida o status da temperatura (frio, ideal... etc)
                    document.getElementById(`freezer${idSensor}`).style.borderColor = color;
                    // Atualizando o src do icone com o status da temperatura
                    // toLowerCase está sendo utilizado para deixar o status com todas as letras minúsculas, para ficar igual ao nome do icone 
                    document.getElementById(`freezer${idSensor}-img`).src = `img/icons/freezer-${status.toLowerCase()}.png`;
                    // Atualizando a descrição dos freezeres com a nova temperatura e o novo status
                    document.getElementById(`status-freezer${idSensor}`).innerHTML = `
                        <h2 style="color:${color}">${resposta[0].temp}°C</h2>
                        <span style="color:${color}">${status}</span>
                    `;

                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }

    var freezer_selected = 1;
    var ultimo_registro = [{
        registro: buscarDadoPorSensor(6)
    },
    {
        registro: buscarDadoPorSensor(7)
    },
    {
        registro: buscarDadoPorSensor(8)
    },
    {
        registro: buscarDadoPorSensor(9)
    },
    {
        registro: buscarDadoPorSensor(10)
    }];

    document.getElementById(`freezer1`).style.boxShadow = `1px 1px 25px ${validarParaCores(ultimo_registro[4].registro)}`;

    // função realiza as validações das faixas de alerta, retornando a cor do status
    function validarParaCores(params) {
        if (Number(params) < 0) {
            return '#348899';
        } else if (Number(params) <= 4) {
            return '#37CA33';
        } else if (Number(params) <= 6) {
            return '#F0C908';
        } else if (Number(params) > 6) {
            return '#BE2D21';
        }
    }
    // função realiza as validações das faixas de alerta, retornando o status
    function validarStatusTemp(params) {
        if (Number(params) < 0) {
            return 'Frio';
        } else if (Number(params) <= 4) {
            return 'Ideal';
        } else if (Number(params) <= 6) {
            return 'Quente';
        } else if (Number(params) > 6) {
            return 'Risco';
        }
    }

    function mudarCoresGrafico(cor) {
        config.data.datasets[0].backgroundColor = cor;
        config.data.datasets[0].borderColor = cor;
    }


    function toogleShadow(f_selected, registro) {
        document.getElementById(`freezer${f_selected}`).style.boxShadow = `none`;
        document.getElementById(`freezer${f_selected}`).style.boxShadow = `1px 1px 25px ${validarParaCores(registro)}`;
    }

    function selectFreezer(freezer, f_selected, ultimo_registo_position) {
        document.getElementById(`freezer${freezer}`).style.boxShadow = 'none';
        freezer_selected = f_selected;
        toogleShadow(f_selected, ultimo_registro[ultimo_registo_position].registro)
        changeSensor(ultimo_registo_position);
    };

    document.getElementById('freezer1').onclick = function () {
        sec_graphic.style.display = 'flex';
        sec_graphic.style.animationName = 'sidein';
        mudarCoresGrafico(validarParaCores(ultimo_registro[0].registro));
        selectFreezer(freezer_selected, 1, 0);
        id_close.style.display = 'block';
    }
    document.getElementById('freezer2').onclick = function () {
        sec_graphic.style.display = 'flex';
        sec_graphic.style.animationName = 'sidein';
        mudarCoresGrafico(validarParaCores(ultimo_registro[1].registro));
        selectFreezer(freezer_selected, 2, 1);
        id_close.style.display = 'block';
    }
    document.getElementById('freezer3').onclick = function () {
        sec_graphic.style.display = 'flex';
        sec_graphic.style.animationName = 'sidein';
        mudarCoresGrafico(validarParaCores(ultimo_registro[2].registro));
        selectFreezer(freezer_selected, 3, 2);
        id_close.style.display = 'block';
    }

    document.getElementById('freezer4').onclick = function () {
        sec_graphic.style.display = 'flex';
        sec_graphic.style.animationName = 'sidein';
        mudarCoresGrafico(validarParaCores(ultimo_registro[3].registro));
        selectFreezer(freezer_selected, 4, 3);
        id_close.style.display = 'block';
    }

    document.getElementById('freezer5').onclick = function () {
        sec_graphic.style.display = 'flex';
        sec_graphic.style.animationName = 'sidein';
        mudarCoresGrafico(validarParaCores(ultimo_registro[4].registro));
        selectFreezer(freezer_selected, 5, 4);
        id_close.style.display = 'block';
    }

    document.getElementById('id_close').onclick = function () {
        sec_graphic.style.animationName = 'sideoff';
        setTimeout(() => sec_graphic.style.display = 'none', 1000)
        id_close.style.display = 'none';
    }

    var config = {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Status ',
                backgroundColor: window.chartColors.blue,
                borderColor: window.chartColors.blue,
                data: [],
                fill: false,
            }]
        },
        options: {
            responsive: true,
            title: {
                display: true,
                text: 'Gráfico médio dos freezers'
            },
            tooltips: {
                mode: 'index',
                intersect: false,
            },
            hover: {
                mode: 'nearest',
                intersect: true
            },
            scales: {
                xAxes: [{
                    display: true,
                    scaleLabel: {
                        display: true,
                        labelString: 'Horário da Leitura'
                    }
                }],
                yAxes: [{
                    display: true,
                    scaleLabel: {
                        display: true,
                        labelString: 'Temperatura em ºC'
                    }
                }]
            }
        }
    };

    // esse "sortearTemperatura()" será desnecessário quando usarmos o backend futuramente
    function sortearTemperatura() {
        var limiteMin = -2;
        var limiteMax = 8;
        var minimoAbsoluto = Math.abs(limiteMin);
        var random = (Math.random() * (minimoAbsoluto + limiteMax) - minimoAbsoluto).toFixed(1);
        return random;
    }

    function recuperarDadosIniciais() {

        // esse "registros" será recuperado do backend futuramente
        var registros = [
            {
                momento: '00:03:42',
                leitura: sortearTemperatura()
            },
            {
                momento: '00:03:52',
                leitura: sortearTemperatura()
            },
            {
                momento: '00:04:02',
                leitura: sortearTemperatura()
            },
            {
                momento: '00:04:12',
                leitura: sortearTemperatura()
            },
            {
                momento: '00:04:22',
                leitura: sortearTemperatura()
            },
            {
                momento: '00:04:32',
                leitura: sortearTemperatura()
            },
            {
                momento: '00:04:42',
                leitura: sortearTemperatura()
            }
        ];

        var contador = 0;

        // registros.length é a quantidade de itens em "registros"
        while (contador < registros.length) {

            config.data.labels.push(registros[contador].momento);  // incluir um novo momento
            config.data.datasets[0].data.push(registros[contador].leitura);  // incluir uma nova leitura

            contador++;
        }

    }

    function receberNovasLeituras() {
        setTimeout(() => {

            // esses "agora" etc até "momentos" serão desnecessários quando usarmos o backend futuramente
            var agora = new Date();
            var hora = agora.getHours();
            var minuto = agora.getMinutes();
            var segundo = agora.getSeconds();
            var momento = `${hora > 9 ? '' : '0'}${hora}:${minuto > 9 ? '' : '0'}${minuto}:${segundo > 9 ? '' : '0'}${segundo}`;

            var random = parseInt(Math.random() * 5);

            // esse "novoRegistro" será recuperado do backend futuramente
            var novoRegistro = {
                momento: momento,
                leitura: sortearTemperatura()
            };

            // tirando e colocando valores no gráfico


            if (random == freezer_selected) {
                config.data.labels.shift(); // apagar o primeiro
                config.data.labels.push(novoRegistro.momento); // incluir um novo momento
                config.data.datasets[0].data.shift();  // apagar o primeiro
                config.data.datasets[0].data.push(novoRegistro.leitura); // incluir uma nova leitura                

            } {

                if (novoRegistro.leitura < 0) {

                    sortearFreezer(random, novoRegistro.leitura, '#348899', 'Frio');

                } else if (novoRegistro.leitura <= 4) {

                    sortearFreezer(random, novoRegistro.leitura, '#37CA33', 'Ideal');

                } else if (novoRegistro.leitura <= 6) {

                    sortearFreezer(random, novoRegistro.leitura, '#F0C908', 'Quente');

                } else if (novoRegistro.leitura > 6) {

                    sortearFreezer(random, novoRegistro.leitura, '#af3b39', 'Risco');

                }
            }



            // agendar a chamada da mesma função para daqui a 7 segundos
            receberNovasLeituras();

            // Atualiza o gráfico
            window.graficoLinha.update();

        }, 2000); // 7000 ms -> 7 segundos
    }

    function sortearFreezer(freezer, registro, cor, status) {
        var freezer1 = document.getElementById('freezer1');
        var freezer2 = document.getElementById('freezer2');
        var freezer3 = document.getElementById('freezer3');
        var freezer4 = document.getElementById('freezer4');
        var freezer5 = document.getElementById('freezer5');

        var img1 = document.getElementById('freezer1-img');
        var img2 = document.getElementById('freezer2-img');
        var img3 = document.getElementById('freezer3-img');
        var img4 = document.getElementById('freezer4-img');
        var img5 = document.getElementById('freezer5-img');

        var status1 = document.getElementById('status-freezer1');
        var status2 = document.getElementById('status-freezer2');
        var status3 = document.getElementById('status-freezer3');
        var status4 = document.getElementById('status-freezer4');
        var status5 = document.getElementById('status-freezer5');

        if (freezer == 1) {
            freezer1.style.borderColor = cor;
            img1.src = `img/icons/freezer-${status.toLowerCase()}.png`;
            status1.innerHTML = `<h2 style="color:${cor}">${registro}°C</h2>`;
            status1.innerHTML += `<p style="color:${cor}">${status}</p>`;

            if (freezer == freezer_selected) {
                toogleShadow(1, registro);
                mudarCoresGrafico(cor);
            }

            ultimo_registro[0].registro = registro;

            registro > 6 ? alert("Freezer 1 em temperatura critica !!") : '';
        } else if (freezer == 2) {
            freezer2.style.borderColor = cor;
            img2.src = `img/icons/freezer-${status.toLowerCase()}.png`;
            status2.innerHTML = `<h2 style="color:${cor}">${registro}°C</h2>`;
            status2.innerHTML += `<p style="color:${cor}">${status}</p>`;

            if (freezer == freezer_selected) {
                toogleShadow(2, registro);
                mudarCoresGrafico(cor);
            }

            ultimo_registro[1].registro = registro;

            registro > 6 ? alert("Freezer 2 em temperatura critica !!") : '';
        } else if (freezer == 3) {
            freezer3.style.borderColor = cor;
            img3.src = `img/icons/freezer-${status.toLowerCase()}.png`;
            status3.innerHTML = `<h2 style="color:${cor}">${registro}°C</h2>`;
            status3.innerHTML += `<p style="color:${cor}">${status}</p>`;

            if (freezer == freezer_selected) {
                toogleShadow(3, registro);
                mudarCoresGrafico(cor);
            }

            ultimo_registro[2].registro = registro;

            registro > 6 ? alert("Freezer 3 em temperatura critica !!") : '';
        } else if (freezer == 4) {
            freezer4.style.borderColor = cor;
            img4.src = `img/icons/freezer-${status.toLowerCase()}.png`;
            status4.innerHTML = `<h2 style="color:${cor}">${registro}°C</h2>`;
            status4.innerHTML += `<p style="color:${cor}">${status}</p>`;

            if (freezer == freezer_selected) {
                toogleShadow(4, registro);
                mudarCoresGrafico(cor);
            }

            ultimo_registro[3].registro = registro;

            registro > 6 ? alert("Freezer 4 em temperatura critica !!") : '';
        } else if (freezer == 5) {
            freezer5.style.borderColor = cor;
            img5.src = `img/icons/freezer-${status.toLowerCase()}.png`;
            status5.innerHTML = `<h2 style="color:${cor}">${registro}°C</h2>`;
            status5.innerHTML += `<p style="color:${cor}">${status}</p>`;

            if (freezer == freezer_selected) {
                // toogleShadow(5,registro);
                mudarCoresGrafico(cor);
            }

            ultimo_registro[4].registro = registro;

            registro > 6 ? alert("Freezer 5 em temperatura critica !!") : '';
        }

    }

    function changeSensor(freezer) {
        var length_array = config.data.labels.length;

        var registros2 = [
            {
                momento: '00:20:42',
                leitura: sortearTemperatura()
            },
            {
                momento: '00:20:52',
                leitura: sortearTemperatura()
            },
            {
                momento: '00:20:02',
                leitura: sortearTemperatura()
            },
            {
                momento: '00:20:12',
                leitura: sortearTemperatura()
            },
            {
                momento: '00:20:22',
                leitura: sortearTemperatura()
            },
            {
                momento: '00:20:32',
                leitura: sortearTemperatura()
            },
            {
                momento: '00:20:42',
                leitura: ultimo_registro[freezer].registro
            }
        ];


        config.data.labels.splice(0, length_array);
        config.data.datasets[0].data = [];

        var contador = 0;

        // registros.length é a quantidade de itens em "registros"
        while (contador < registros2.length) {
            config.data.labels.push(registros2[contador].momento);  // incluir um novo momento
            config.data.datasets[0].data.push(registros2[contador].leitura);  // incluir uma nova leitura

            contador++;
        }

        if (ultimo_registro[freezer].registro < 0) {

        }

        window.graficoLinha.update();
    }

    function plotarGrafico() {
        // chamar os 7 últimos registros de leitura
        recuperarDadosIniciais();

        // criação do gráfico na página
        var ctx = document.getElementById('c_grafico').getContext('2d');
        window.graficoLinha = new Chart(ctx, config);

        // função que agenda a recuperação da última leitura para daqui a 7 segundos
        receberNovasLeituras();
    }

    // indicando que a função "plotarGrafico" será invocada assim que a página carregar
    window.onload = plotarGrafico;

</script>